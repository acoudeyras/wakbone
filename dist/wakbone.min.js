!function(){(function(){define("core/underscore-ext",["underscore.string"],function(){var a;return _.mixin(_.str.exports()),a={lowerCamelize:function(a){return a=_.camelize(a),a[0].toLowerCase()+a.substring(1,a.length)}},_.mixin(a),null})}).call(this),function(){define("core/helpers",["./underscore-ext","moment"],function(a,b){return b.wakFormat="DD!MM!YYYY",Function.prototype.property=function(a,b){return Object.defineProperty(this.prototype,a,b)},Function.prototype.getter=function(a,b){return Object.defineProperty(this.prototype,a,{get:b})},Function.prototype.lazyval=function(a,b){return Object.defineProperty(this.prototype,a,{get:function(){var c;return c="__"+a,null!=this[c]?this[c]:this[c]=b.apply(this)}})},{resolvedPromise:function(a){var b;return b=$.Deferred(),b.resolve(a),b.promise()},rejectedPromise:function(a){var b;return b=$.Deferred(),b.reject(a),b.promise()},log:function(a){return console.log(a)},"throw":function(a,b){throw null==b&&(b=Error),new b(a)},throwIf:function(a,b){return a?this["throw"](b):void 0},moment:b}})}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1},b=[].slice;define("core/check",[],function(){var c,d,e;return e={notNull:{message:"should not be null",predicate:function(a){return null!=a}},isString:{message:"should be of type string",predicate:function(a){return"string"==typeof a}},notEmpty:{message:"should not be empty",predicate:function(a){return(null!=a?a.length:void 0)>0}},"in":{message:"should in the list",predicate:function(b,c){var d;return d=c[0],a.call(d,b)>=0}}},d=function(a,b,c,d){return a.forEach(function(a){if(!c(a,d))throw new Error(b)})},c=function(){var a,c;return a=1<=arguments.length?b.call(arguments,0):[],c=function(){var c;return c={},Object.keys(e).forEach(function(f){var g;return g=e[f],c[f]=function(){var c;return c=1<=arguments.length?b.call(arguments,0):[],d(a,g.message,g.predicate,c),this}}),c},c()}})}.call(this),function(){var a=[].slice;define("core/wak-url-builder",["./helpers","./check"],function(b,c){var d,e,f,g;return g=function(a){return'"'+a+'"'},d=function(){function a(a){this.root=a,this._queryParams={},this._pathParams=[]}return a.prototype.query=function(a,b){return this._queryParams[a]=b},a.prototype.path=function(a){return this._pathParams.push(a)},a.prototype.clearQuery=function(){return this._queryParams={}},a.prototype.clearPath=function(){return this._pathParams=[]},a.prototype.buildPathParams=function(){return this._pathParams.length?"/"+this._pathParams.join("/"):""},a.prototype.buildQueryParams=function(){var a,b=this;return a=Object.keys(this._queryParams),a.length?(a=a.map(function(a){return a+"="+b._queryParams[a]}),"?"+a.join("&")):""},a.prototype.build=function(){return this.root+this.buildPathParams()+this.buildQueryParams()},a}(),f=["$all","count","average","min","max","sum"],e=function(){function e(a){this.root=a,c(this.root).notNull().isString().notEmpty(),this.urlBuilder=new d(this.root)}return e.prototype.key=function(a){return this.urlBuilder=new d(this.root+"("+a+")"),this},e.prototype.select=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],this.urlBuilder.path(b.join(",")),this},e.prototype._numParam=function(a,c){var d;return d=parseInt(a,10),d!==d?(b.log("bad "+c+" parameter: "+a),this):(this.urlBuilder.query("$"+c,d),this)},e.prototype.clearSelect=function(){return this.urlBuilder.clearPath(),this},e.prototype.limit=function(a){return this._numParam(a,"limit")},e.prototype.skip=function(a){return this._numParam(a,"skip")},e.prototype.timeout=function(a){return this._numParam(a,"timeout")},e.prototype.expand=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],b=b.join(","),this.urlBuilder.query("$expand",b),this},e.prototype.where=function(a){return this.urlBuilder.query("$filter",g(a)),this},e.prototype.orderBy=function(a){var b,c,d;return d=function(){var d;d=[];for(c in a)b=a[c],d.push(c+" "+b);return d}(),this.urlBuilder.query("$orderby",d.join(",")),this},e.prototype.distinct=function(a){return this.urlBuilder.clearPath(),this.select(a),this.urlBuilder.query("$distinct","true"),this},e.prototype.compute=function(a,b){return null==b&&(b="$all"),c(b)["in"](f),this.urlBuilder.clearPath(),this.select(a),this.urlBuilder.query("$compute",b),this},e.getter("url",function(){return this.urlBuilder.build()}),e}()})}.call(this),function(){define("core/backbone-walker",[],function(){var a,b,c,d,e,f,g,h;return e=function(a){return"object"==typeof a},d=function(a){return e(a)&&a instanceof Backbone.Model},c=function(a){return e(a)&&a instanceof Backbone.Collection},b=function(a){var b,c;return c=a.indexOf("."),b=a.indexOf("["),c=-1===c?1/0:c,b=-1===b?1/0:b,{dot:c,bracket:b,noneMatch:1/0===c&&1/0===b}},f=function(a,b){var c,d,e;return c=a.split(b),e=c[0],c.splice(0,1),d=c.join(b),{val:e,remaining:d}},h=function(a,b){var e,g,h,i;if(i=f(b,"."),h=i.val,e=i.remaining,g=a.get(h),!d(g||!c(g)))throw new Error("Property "+h+" is not a model or a collection or is not fetched");return g.walk(e)},g=function(a,b){var d,e,g,h,i,j;if(i=f(b,"["),h=i.val,d=i.remaining,g=a.get(h),!c(g))throw new Error("Property "+h+" is not a collection or is not fetched");if(j=f(d,"]"),h=j.val,d=j.remaining,_.isBlank(d))throw new Error("Invalid walk expression "+b+" : missing ]");return _.startsWith(d,".")&&(d=_.splice(d,0,1)),e=g.at(+h),e.walk(d)},a=function(){function a(a){this.model=a}return a.prototype.walk=function(a){var c,d;return d=b(a),c=null,c=d.noneMatch?{model:this.model,property:a}:d.dot<d.bracket?h(this.model,a):g(this.model,a),c.val=function(){return Backbone.Model.prototype.get.call(c.model,c.property)},c},a}()})}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};define("core/model-serializer",["backbone"],function(){var b,c;return c=["__entityModel","__KEY","__STAMP","id","ID","uri"],b=function(){function b(a){this.model=a,this.dataClass=this.model.dataClass}return b.prototype.toJSON=function(){var a,b;return(a=this.model.attributes)?(b=this.model.toJSON(),JSON.stringify(b)):null},b.prototype.fromJSON=function(b){var d,e,f,g;f={};for(e in b)g=b[e],a.call(c,e)>=0||(d=this.dataClass.attr(e),f[e]=d.fromRaw(g));return f.$stamp=b.__STAMP,f.id=b.ID,f},b}()})}.call(this),function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};define("core/wak-model",["./wak-url-builder","./backbone-walker","./helpers","./model-serializer","backbone"],function(c,d,e,f){var g,h;return h=["__entityModel","__KEY","__STAMP","id","ID","uri"],g=function(e,g,h){return{constructor:function(a){return null==a&&(a={}),null==a.id&&(a.id=a.ID),this._urlBuilder=new c(this.urlRoot),null!=a.id&&this._urlBuilder.key(a.id),this.walker=new d(this),Backbone.Model.prototype.constructor.apply(this,arguments)},dataClass:e,dataloader:h,catalog:g,expand:function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],this._expanded=this._urlBuilder.expand(b),this},walk:function(a){return this.walker.walk(a)},get:function(a){return this.walk(a).val()},set:function(a,b){var c,d,e;return"object"==typeof a?(null!=a.id&&this._urlBuilder.key(a.id),Backbone.Model.prototype.set.apply(this,arguments)):("id"===a&&this._urlBuilder.key(b),e=this.walk(a),c=e.model,d=e.property,Backbone.Model.prototype.set.call(c,d,b))},toJSON:function(){var a,c,d,f,g,h,i,j=this;h=function(a,b){var c;return c=j.get(a),null!=c?f[b]=c:void 0},f={},c=_.pluck(e.attr(),"name"),i=this.attributes;for(d in i)if(g=i[d],!(b.call(c,d)<0||(a=e.attr(d),a.readOnly)))if(null!=g){if(!(g instanceof Backbone.Collection))if(g instanceof Backbone.Model){if(g.isNew())throw new Error("You must first save a entity before making it related to another");f[d]={__KEY:g.get("id")}}else"function"!=typeof g.toJSON?f[d]=g:(g=g.toJSON(),void 0!==g&&(f[d]=g))}else f[d]=null;return h("$stamp","__STAMP"),h("id","__KEY"),f},parse:function(a){var b;return b=new f(this),b.fromJSON(a)},urlRoot:e.dataURI,url:function(){return this._urlBuilder.url},sync:function(a,b,c){var d;return d=$.Deferred(),this.dataloader[a](b,c).done(function(a){return"function"==typeof c.success&&c.success(a,!0),d.resolve()}).fail(function(a){var e,f;return e=a.responseJSON,f=null!=e?e.__ERROR:void 0,"function"==typeof c.error&&c.error(e,f),b.set("$errors",f),d.reject(f)}),d.promise()}}},{create:function(a,b,c){var d,e;return e=g(a,b,c),d=Backbone.Model.extend(e),d.catalog=b,d.dataClass=a,d}}})}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};define("core/orderby-parser",[],function(){var b,c,d,e,f,g,h;return c={ASC:["ASC","asc",1,!0],DESC:["DESC","desc",0,-1,!1]},e=function(b){return null==b?"ASC":("string"==typeof b&&(b=b.trim()),a.call(c.ASC,b)>=0?"ASC":a.call(c.DESC,b)>=0?"DESC":"ASC")},g=function(a,b){var c;return c=e(b),{field:a.trim(),direction:c}},h=function(a){var b,c,d;return d=a.trim().split(" "),c=d[0],b=d[1],g(c,b)},d=function(a){var b,c,d,e,f;for(d={},e=0,f=a.length;f>e;e++)b=a[e],c=h(b),d[c.field]=c.direction;return d},f=function(a){var b,c,d,e;e={};for(c in a)b=a[c],d=g(c,b),e[d.field]=d.direction;return e},b=function(a){var b;return a.length>1?d(a):(b=a[0],"string"==typeof b?d(b.split(",")):f(b))}})}.call(this),function(){var a=[].slice;define("core/query-state",["./wak-url-builder","./orderby-parser"],function(b,c){var d,e;return e=function(a){return-1!==a.indexOf(".")},d=function(){function d(a,c,e){this.collection=a,this.rootUrl=c,this.originState=e,this.state=_.extend(d["default"],this.originState),this._urlBuilder=new b(this.rootUrl)}return d.prototype.where=function(a){return this.state.where=a,this._urlBuilder.where(a),this},d.prototype.orderBy=function(){var b,d;return b=1<=arguments.length?a.call(arguments,0):[],d=c(b),this.state.orderBy=d,this._urlBuilder.orderBy(d),this},d.prototype.select=function(){var b,c,d;return d=1<=arguments.length?a.call(arguments,0):[],this.state.select=d,b=function(){var a,b,f;for(f=[],a=0,b=d.length;b>a;a++)c=d[a],e(c)&&f.push(c.split(".")[0]);return f}(),b.length&&this.expand(b),this._urlBuilder.select(d),this},d.prototype.skip=function(a){return this.state.skip=a,this._urlBuilder.skip(a),this},d.prototype.limit=function(a){return this.state.limit=a,this._urlBuilder.limit(a),this},d.prototype.expand=function(){var b;return b=1<=arguments.length?a.call(arguments,0):[],this.state.expands=b,this._urlBuilder.expand(b),this},d.prototype.clear=function(){return this.state=_.extend(d["default"],this.originState),this._urlBuilder=new b(this.rootUrl)},d.prototype.url=function(){return this._urlBuilder.url},d["default"]={skip:0,limit:100},d}()})}.call(this),function(){define("core/wak-collection",["./query-state","backbone"],function(a){var b;return b=function(b,c,d){return{constructor:function(){return this.query=new a(this,b.dataURI),Backbone.Collection.prototype.constructor.apply(this,arguments)},dataClass:b,catalog:d,model:c,toJSON:function(){return 0===this.models.length?void 0:this.models.map(function(a){return a.toJSON()})},parse:function(a){return this.$total=a.__COUNT,a.__ENTITIES},url:function(){return this.query.url()}}},{createRelated:function(a,b){return a.extend({url:b+"&$method=subentityset"})},create:function(a,c,d){var e,f;return f=b(a,c,d),e=Backbone.Collection.extend(f),e.dataClass=a,e.catalog=d,e}}})}.call(this),function(){define("core/types",["./helpers"],function(){var a,b;return a=function(a){return a},b={string:{fromRaw:a,toRaw:a},number:{fromRaw:a,toRaw:a},"long":{fromRaw:a,toRaw:a},date:{fromRaw:function(a){return moment(a,moment.wakFormat)},toRaw:a},image:{fromRaw:a,toRaw:a}}})}.call(this),function(){var a=[].indexOf||function(a){for(var b=0,c=this.length;c>b;b++)if(b in this&&this[b]===a)return b;return-1};define("core/attribute",["./types","./wak-collection","./helpers"],function(b,c){var d;return d=function(){function d(c,e){var f,g,h;if(this.identifying=c.identifying,this.indexed=c.indexed,this.kind=c.kind,this.name=c.name,this.scope=c.scope,this.type=c.type,this.path=c.path,this.dataClass=e,null==this.identifying&&(this.identifying=!1),this.isRaw=(f=this.kind,a.call(d.rawKinds,f)>=0),this.readOnly=(g=this.kind,a.call(d.readOnlyKinds,g)>=0||(h=this.type,a.call(d.readOnlyTypes,h)>=0)),this.catalog=this.dataClass.catalog,this.isRaw&&(this.typeExtra=b[this.type],null==this.typeExtra))throw new Error("type "+this.type+" not supported")}return d.lazyval("RelatedModel",function(){var a;return"relatedEntity"!==this.kind?null:(a=this.catalog.constructor.classNameInCatalog(this.type),this.catalog[a].Model)}),d.lazyval("RelatedCollection",function(){var a;return"relatedEntities"!==this.kind?null:(a=this.catalog.$entryFromCollectionName(this.type),a.Collection)}),d.prototype._convertToRelatedModel=function(a){var b;return null===a?null:null!=a.__deferred?(b=a.__deferred.__KEY,new this.RelatedModel({id:b})):new this.RelatedModel(a)},d.prototype._convertToRelatedCollection=function(a){var b,d,e,f,g;return null===a?null:(e=null!=(f=a.__deferred)?f.uri:void 0,b=c.createRelated(this.RelatedCollection,e),d=new b,(null!=(g=a.__ENTITIES)?g.length:void 0)>0&&d.set(a,{parse:!0}),d)},d.prototype.fromRaw=function(a){return null!=this.typeExtra?this.typeExtra.fromRaw(a):"relatedEntity"===this.kind?this._convertToRelatedModel(a):"relatedEntities"===this.kind?this._convertToRelatedCollection(a):console.log("oups")},d.prototype.toRaw=function(){},d.rawKinds=["storage","alias","calculated"],d.readOnlyKinds=["calculated","alias"],d.readOnlyTypes=["image"],d}()})}.call(this),function(){define("core/http-requester",["./model-serializer","./helpers","backbone"],function(a,b){var c,d,e;return d={dataType:"json",contentType:"application/json"},e=function(a,b){return $.extend({},a,b,d)},c=function(){function c(){}return c.prototype.read=function(a,b){return Backbone.Model.prototype.sync.apply(a,["read",a,b])},c.prototype.upsert=function(c,d){var f,g,h,i;try{f=new a(c).toJSON()}catch(j){return g=j,b.rejectedPromise(g.message)}return null==f?b.resolvedPromise():(i=c.url()+"/?$method=update",h={url:i,data:f,type:"POST"},$.ajax(e(h,d)))},c.prototype.create=function(a,b){return this.upsert(a,b)},c.prototype.update=function(a,b){return this.upsert(a,b)},c.prototype["delete"]=function(a,b){var c,d;return d=a.url()+"/?$method=delete",c={url:d,type:"POST"},$.ajax(e(c,b))},c}()})}.call(this),function(){define("core/catalog",["./wak-model","./wak-collection","./attribute","./http-requester","./helpers","./check","backbone"],function(a,b,c,d,e){var f,g;return g=function(){function a(a,b){var d,e=this;this.className=a.className,this.collectionName=a.collectionName,this.dataURI=a.dataURI,d=a.attributes,this.catalog=b,this._attributes=d.map(function(a){return new c(a,e)}),this._attributesByName=_.indexBy(this._attributes,"name")}return a.prototype.finalize=function(a,b){return this.Collection=a,this.Model=b,this.entities=new this.Collection},a.prototype.attr=function(a){return null==a?this._attributes:this._attributesByName[a]},a}(),f=function(){function c(a){var b,f,g,h,i;for(this.$classNames=[],this.$dataLoader=new d,this._colsByEntryName={},i=a.dataClasses,g=0,h=i.length;h>g;g++)f=i[g],b=c.classNameInCatalog(f.className),this.$classNames.push(b),e.throwIf(null!=this[b],"conflict in catalog with dataclass "+b),this._colsByEntryName[f.collectionName]=b,this._addEntry(b,f)}return c.prototype.$entryFromCollectionName=function(a){var b;return b=this._colsByEntryName[a],this[b]},c.prototype._addEntry=function(c,d){var e,f,h;return h=new g(d,this),f=a.create(h,this,this.$dataLoader),e=b.create(h,f,this),h.finalize(e,f),this[c]=h},c.classNameInCatalog=function(a){return _.lowerCamelize(a)},c.load=function(){return $.ajax("/rest/$catalog/$all").then(function(a){return new c(a)})},c}()})}.call(this),function(){require.config({paths:{jquery:"../bower_components/jquery/jquery",underscore:"../bower_components/underscore/underscore",backbone:"../bower_components/backbone/backbone","underscore.string":"../bower_components/underscore.string/dist/underscore.string.min",moment:"../bower_components/moment/moment"},shim:{backbone:{deps:["underscore","jquery"]},"underscore.string":{deps:["underscore"]}}}),define("wakbone",["./core/catalog"],function(a){return a})}.call(this)}();